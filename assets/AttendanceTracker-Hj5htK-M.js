import{c as U,g as V,i as W,r,s as y,u as p,j as e,C as I,B as f,X}from"./index-CugQ5QCp.js";import{C as M,c as T,a as G,b as J}from"./card-BhFlIpAy.js";import{D as Y,a as Z,b as ee,c as te}from"./dialog-Bq7DMun_.js";import{u as se}from"./useQuery-kEhrXH_B.js";import{C as P}from"./check-VQELwqnM.js";import{P as ae}from"./play-Cr6Kb4dX.js";import{f as j}from"./format-BuON0pZi.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const v=U("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),me=()=>{const{user:a}=V(),q=W(),d=r.useRef(null),k=r.useRef(null),[m,u]=r.useState(!1),[_,E]=r.useState("check_in"),[h,N]=r.useState(null),[l,g]=r.useState(null),[O,C]=r.useState("00:00:00"),w=j(new Date,"yyyy-MM-dd"),{data:x=[],refetch:R}=se({queryKey:["attendance-sessions",a==null?void 0:a.id,w],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:t}=await y.from("attendance_sessions").select("*").eq("user_id",a.id).eq("date",w).order("check_in_time",{ascending:!0});return t||[]},enabled:!!(a!=null&&a.id)}),n=x.find(t=>!t.check_out_time),i=!!n,b=x.reduce((t,s)=>{if(s.duration_minutes)return t+s.duration_minutes;if(s.check_in_time&&!s.check_out_time){const o=new Date(s.check_in_time).getTime(),c=Date.now();return t+Math.floor((c-o)/(1e3*60))}return t},0),F=Math.floor(b/60),H=b%60;r.useEffect(()=>{if(!i||!n){C("00:00:00");return}const t=setInterval(()=>{const s=new Date(n.check_in_time).getTime(),c=Date.now()-s,A=Math.floor(c/(1e3*60*60)),B=Math.floor(c%(1e3*60*60)/(1e3*60)),K=Math.floor(c%(1e3*60)/1e3);C(`${A.toString().padStart(2,"0")}:${B.toString().padStart(2,"0")}:${K.toString().padStart(2,"0")}`)},1e3);return()=>clearInterval(t)},[i,n]);const S=r.useCallback(async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});N(t),d.current&&(d.current.srcObject=t)}catch{p.error("Failed to access camera. Please allow camera permissions."),u(!1)}},[]),D=r.useCallback(()=>{h&&(h.getTracks().forEach(t=>t.stop()),N(null))},[h]),$=t=>{E(t),g(null),u(!0)};r.useEffect(()=>{m&&!h&&S()},[m,h,S]),r.useEffect(()=>{m||D()},[m,D]);const L=()=>{if(d.current&&k.current){const t=d.current,s=k.current;s.width=t.videoWidth,s.height=t.videoHeight;const o=s.getContext("2d");if(o){o.drawImage(t,0,0);const c=s.toDataURL("image/jpeg",.8);g(c)}}},Q=()=>{g(null)},z=async()=>{if(!(!(a!=null&&a.id)||!l))try{if(_==="check_in"){const{error:t}=await y.from("attendance_sessions").insert({user_id:a.id,date:w,check_in_time:new Date().toISOString(),check_in_photo:l});if(t)throw t;p.success("Checked in successfully!")}else{if(!n)return;const t=new Date(n.check_in_time).getTime(),s=Date.now(),o=Math.floor((s-t)/(1e3*60)),{error:c}=await y.from("attendance_sessions").update({check_out_time:new Date().toISOString(),check_out_photo:l,duration_minutes:o}).eq("id",n.id);if(c)throw c;p.success("Checked out successfully!")}u(!1),g(null),R(),q.invalidateQueries({queryKey:["today-attendance"]})}catch(t){p.error("Failed to save attendance"),console.error(t)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(M,{className:"border-2 border-primary/20 bg-gradient-to-r from-primary/5 to-transparent",children:e.jsx(T,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-2xl gradient-bg flex items-center justify-center",children:e.jsx(I,{className:"w-8 h-8 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Current Session"}),e.jsx("p",{className:"text-4xl font-bold text-foreground font-mono",children:i?O:"00:00:00"}),i&&n&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Started at ",j(new Date(n.check_in_time),"h:mm a")]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Today's Total"}),e.jsxs("p",{className:"text-2xl font-bold text-foreground",children:[F,"h ",H,"m"]})]}),e.jsxs(f,{onClick:()=>$(i?"check_out":"check_in"),size:"lg",className:i?"bg-destructive hover:bg-destructive/90":"bg-green-600 hover:bg-green-700",children:[e.jsx(v,{className:"w-5 h-5 mr-2"}),i?"Check Out":"Check In"]})]})]})})}),e.jsxs(M,{children:[e.jsx(G,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5 text-primary"}),"Today's Sessions (",x.length,")"]})}),e.jsx(T,{children:x.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-6",children:"No sessions logged today. Check in to start tracking!"}):e.jsx("div",{className:"space-y-3",children:x.map((t,s)=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${t.check_out_time?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"}`,children:t.check_out_time?e.jsx(P,{className:"w-5 h-5"}):e.jsx(ae,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-foreground",children:["Session ",s+1]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[j(new Date(t.check_in_time),"h:mm a"),t.check_out_time&&e.jsxs(e.Fragment,{children:[" â†’ ",j(new Date(t.check_out_time),"h:mm a")]})]})]})]}),e.jsx("div",{className:"text-right",children:t.duration_minutes?e.jsxs("p",{className:"font-semibold text-foreground",children:[Math.floor(t.duration_minutes/60),"h ",t.duration_minutes%60,"m"]}):e.jsx("span",{className:"px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-700",children:"In Progress"})})]},t.id))})})]}),e.jsx(Y,{open:m,onOpenChange:u,children:e.jsxs(Z,{className:"sm:max-w-md",children:[e.jsx(ee,{children:e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(v,{className:"w-5 h-5"}),_==="check_in"?"Check In Photo":"Check Out Photo"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative aspect-video bg-black rounded-lg overflow-hidden",children:l?e.jsx("img",{src:l,alt:"Captured",className:"w-full h-full object-cover"}):e.jsx("video",{ref:d,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"})}),e.jsx("canvas",{ref:k,className:"hidden"}),e.jsx("div",{className:"flex gap-2",children:l?e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"outline",onClick:Q,className:"flex-1",children:"Retake"}),e.jsxs(f,{onClick:z,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),"Confirm ",_==="check_in"?"Check In":"Check Out"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(f,{variant:"outline",onClick:()=>u(!1),className:"flex-1",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Cancel"]}),e.jsxs(f,{onClick:L,className:"flex-1",children:[e.jsx(v,{className:"w-4 h-4 mr-2"}),"Capture"]})]})})]})]})})]})};export{me as default};
