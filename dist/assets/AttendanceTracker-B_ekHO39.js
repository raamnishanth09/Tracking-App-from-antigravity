import{c as V,g as X,i as G,r,s as N,u as d,j as e,C as q,B as p,X as J}from"./index-C9PopRjW.js";import{C as E,c as O,a as Y,b as Z}from"./card-Dr7gnhHP.js";import{D as ee,a as te,b as se,c as ae}from"./dialog-BWr1A6GL.js";import{u as re}from"./useQuery-Cs1p8e55.js";import{C as R}from"./check-B8NMrcNy.js";import{P as ne}from"./play-BqBd_buH.js";import{f as w}from"./format-BuON0pZi.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const b=V("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),he=()=>{const{user:a}=X(),F=G(),u=r.useRef(null),v=r.useRef(null),[h,x]=r.useState(!1),[j,$]=r.useState("check_in"),[f,S]=r.useState(null),[m,k]=r.useState(null),[A,D]=r.useState("00:00:00"),_=w(new Date,"yyyy-MM-dd"),{data:g=[],refetch:H}=re({queryKey:["attendance-sessions",a==null?void 0:a.id,_],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:t}=await N.from("attendance_sessions").select("*").eq("user_id",a.id).eq("date",_).order("check_in_time",{ascending:!0});return t||[]},enabled:!!(a!=null&&a.id)}),n=g.find(t=>!t.check_out_time),i=!!n,T=g.reduce((t,s)=>{if(s.duration_minutes)return t+s.duration_minutes;if(s.check_in_time&&!s.check_out_time){const o=new Date(s.check_in_time).getTime(),c=Date.now();return t+Math.floor((c-o)/(1e3*60))}return t},0),L=Math.floor(T/60),Q=T%60;r.useEffect(()=>{if(!i||!n){D("00:00:00");return}const t=setInterval(()=>{const s=new Date(n.check_in_time).getTime(),c=Date.now()-s,l=Math.floor(c/(1e3*60*60)),C=Math.floor(c%(1e3*60*60)/(1e3*60)),W=Math.floor(c%(1e3*60)/1e3);D(`${l.toString().padStart(2,"0")}:${C.toString().padStart(2,"0")}:${W.toString().padStart(2,"0")}`)},1e3);return()=>clearInterval(t)},[i,n]);const[y,I]=r.useState(!1),M=r.useCallback(async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});S(t),u.current&&(u.current.srcObject=t)}catch(t){console.error("Camera access error:",t),d.error("Failed to access camera. Please allow camera permissions."),x(!1)}},[]),P=r.useCallback(()=>{f&&(f.getTracks().forEach(t=>t.stop()),S(null))},[f]),z=t=>{$(t),k(null),x(!0)};r.useEffect(()=>{h&&!f&&M()},[h,f,M]),r.useEffect(()=>{h||P()},[h,P]);const B=()=>{if(u.current&&v.current){const t=u.current,s=v.current,o=400,c=o/t.videoWidth;s.width=o,s.height=t.videoHeight*c;const l=s.getContext("2d");if(l){l.drawImage(t,0,0,s.width,s.height);const C=s.toDataURL("image/jpeg",.4);k(C)}}},K=()=>{k(null)},U=async()=>{if(!(a!=null&&a.id)||!m||y)return;I(!0);const t=d.loading(j==="check_in"?"Checking in...":"Checking out...");try{if(j==="check_in"){const{error:s}=await N.from("attendance_sessions").insert({user_id:a.id,date:_,check_in_time:new Date().toISOString(),check_in_photo:m});if(s)throw s;d.success("Checked in successfully!",{id:t})}else{if(!n){d.error("No active session found",{id:t});return}const s=new Date(n.check_in_time).getTime(),o=Date.now(),c=Math.floor((o-s)/(1e3*60)),{error:l}=await N.from("attendance_sessions").update({check_out_time:new Date().toISOString(),check_out_photo:m,duration_minutes:c}).eq("id",n.id);if(l)throw l;d.success("Checked out successfully!",{id:t})}x(!1),k(null),await H(),await F.invalidateQueries({queryKey:["today-attendance"]})}catch(s){s.name==="AbortError"?(console.warn("Attendance request was aborted. This might be due to a network change or component unmounting."),d.error("Connection interrupted. Please try again.",{id:t})):(d.error(`Error: ${s.message||"Failed to save attendance"}`,{id:t}),console.error("Attendance save error:",s))}finally{I(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(E,{className:"border-2 border-primary/20 bg-gradient-to-r from-primary/5 to-transparent",children:e.jsx(O,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-2xl gradient-bg flex items-center justify-center",children:e.jsx(q,{className:"w-8 h-8 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Current Session"}),e.jsx("p",{className:"text-4xl font-bold text-foreground font-mono",children:i?A:"00:00:00"}),i&&n&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Started at ",w(new Date(n.check_in_time),"h:mm a")]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Today's Total"}),e.jsxs("p",{className:"text-2xl font-bold text-foreground",children:[L,"h ",Q,"m"]})]}),e.jsxs(p,{onClick:()=>z(i?"check_out":"check_in"),size:"lg",className:i?"bg-destructive hover:bg-destructive/90":"bg-green-600 hover:bg-green-700",children:[e.jsx(b,{className:"w-5 h-5 mr-2"}),i?"Check Out":"Check In"]})]})]})})}),e.jsxs(E,{children:[e.jsx(Y,{children:e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5 text-primary"}),"Today's Sessions (",g.length,")"]})}),e.jsx(O,{children:g.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-6",children:"No sessions logged today. Check in to start tracking!"}):e.jsx("div",{className:"space-y-3",children:g.map((t,s)=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${t.check_out_time?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"}`,children:t.check_out_time?e.jsx(R,{className:"w-5 h-5"}):e.jsx(ne,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-foreground",children:["Session ",s+1]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[w(new Date(t.check_in_time),"h:mm a"),t.check_out_time&&e.jsxs(e.Fragment,{children:[" â†’ ",w(new Date(t.check_out_time),"h:mm a")]})]})]})]}),e.jsx("div",{className:"text-right",children:t.duration_minutes?e.jsxs("p",{className:"font-semibold text-foreground",children:[Math.floor(t.duration_minutes/60),"h ",t.duration_minutes%60,"m"]}):e.jsx("span",{className:"px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-700",children:"In Progress"})})]},t.id))})})]}),e.jsx(ee,{open:h,onOpenChange:x,children:e.jsxs(te,{className:"sm:max-w-md",children:[e.jsx(se,{children:e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5"}),j==="check_in"?"Check In Photo":"Check Out Photo"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative aspect-video bg-black rounded-lg overflow-hidden",children:m?e.jsx("img",{src:m,alt:"Captured",className:"w-full h-full object-cover"}):e.jsx("video",{ref:u,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"})}),e.jsx("canvas",{ref:v,className:"hidden"}),e.jsx("div",{className:"flex gap-2",children:m?e.jsxs(e.Fragment,{children:[e.jsx(p,{variant:"outline",onClick:K,className:"flex-1",children:"Retake"}),e.jsxs(p,{onClick:U,disabled:y,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),y?"Saving...":`Confirm ${j==="check_in"?"Check In":"Check Out"}`]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(p,{variant:"outline",onClick:()=>x(!1),className:"flex-1",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Cancel"]}),e.jsxs(p,{onClick:B,className:"flex-1",children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"Capture"]})]})})]})]})})]})};export{he as default};
