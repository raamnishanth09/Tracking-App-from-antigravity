import{g as X,i as Y,r as x,j as e,B as d,I as k,u as c,s as i,a as Z,A as ee,b as se}from"./index-C9PopRjW.js";import{C as ae,c as te}from"./card-Dr7gnhHP.js";import{T as le}from"./textarea-ltqZxKs9.js";import{B as h}from"./badge-DvKv-gUx.js";import{S as p,a as g,b as f,c as v,d as n}from"./select-N4MQfODT.js";import{D as ie,a as re,b as ne,c as de,d as ce}from"./dialog-BWr1A6GL.js";import{T as oe,a as me,b as B,c as E}from"./tabs-DCKh9Q3u.js";import{u as _}from"./useQuery-Cs1p8e55.js";import{P as ue}from"./plus-DZdoEr8Y.js";import{P as K,T as A}from"./trash-2-DRgJ7cG6.js";import{f as Q}from"./format-BuON0pZi.js";import"./index-BjHVK9V2.js";import"./check-B8NMrcNy.js";const Ce=()=>{const{user:j}=X(),b=Y(),[z,o]=x.useState(!1),[N,T]=x.useState(!1),[C,D]=x.useState(!1),[S,I]=x.useState(null),[a,r]=x.useState({title:"",description:"",dueDate:"",assignedTo:"",projectId:"",status:"pending"}),{data:m=[]}=_({queryKey:["all-tasks"],queryFn:async()=>{const{data:s}=await i.from("tasks").select("*").order("created_at",{ascending:!1});if(!s)return[];const l=[...new Set(s.map(t=>t.assigned_to).filter(Boolean))],{data:u}=await i.from("profiles").select("user_id, full_name").in("user_id",l),G=[...new Set(s.map(t=>t.project_id).filter(Boolean))],{data:y}=await i.from("projects").select("id, name").in("id",G),J=new Map((u==null?void 0:u.map(t=>[t.user_id,t]))||[]),W=new Map((y==null?void 0:y.map(t=>[t.id,t]))||[]);return s.map(t=>({...t,assignee:t.assigned_to?J.get(t.assigned_to):void 0,project:t.project_id?W.get(t.project_id):void 0}))}}),{data:L=[]}=_({queryKey:["team-members-list"],queryFn:async()=>{const{data:s}=await i.from("profiles").select("user_id, full_name").order("full_name");return s||[]}}),{data:U=[]}=_({queryKey:["projects-list"],queryFn:async()=>{const{data:s}=await i.from("projects").select("id, name").eq("status","active").order("name");return s||[]}}),$=()=>{T(!1),I(null),r({title:"",description:"",dueDate:"",assignedTo:"",projectId:"",status:"pending"}),o(!0)},q=s=>{T(!0),I(s),r({title:s.title,description:s.description||"",dueDate:s.due_date||"",assignedTo:s.assigned_to||"",projectId:s.project_id||"",status:s.status}),o(!0)},H=async()=>{if(!(j!=null&&j.id)||!a.title.trim()){c.error("Please enter a task title");return}D(!0);try{if(N&&S){const{error:s}=await i.from("tasks").update({title:a.title.trim(),description:a.description.trim()||null,due_date:a.dueDate||null,assigned_to:a.assignedTo||null,project_id:a.projectId||null,status:a.status}).eq("id",S.id);if(s)throw s;c.success("Task updated!")}else{const{error:s}=await i.from("tasks").insert([{title:a.title.trim(),description:a.description.trim()||null,due_date:a.dueDate||null,assigned_to:a.assignedTo||null,assigned_by:j.id,project_id:a.projectId||null,status:a.status}]);if(s)throw s;c.success("Task created!")}o(!1),b.invalidateQueries({queryKey:["all-tasks"]})}catch(s){c.error("Failed to save task"),console.error(s)}finally{D(!1)}},P=async s=>{if(!confirm("Delete this task?"))return;const{error:l}=await i.from("tasks").delete().eq("id",s);if(l){c.error("Failed to delete");return}c.success("Task deleted"),b.invalidateQueries({queryKey:["all-tasks"]})},O=async(s,l)=>{const{error:u}=await i.from("tasks").update({status:l}).eq("id",s);u||b.invalidateQueries({queryKey:["all-tasks"]})},R=s=>{switch(s){case"completed":return"bg-green-100 text-green-700";case"in_progress":return"bg-blue-100 text-blue-700";case"pending":return"bg-yellow-100 text-yellow-700";default:return"bg-gray-100 text-gray-700"}},M=m.filter(s=>s.status==="pending"),F=m.filter(s=>s.status==="in_progress"),V=m.filter(s=>s.status==="completed"),w=({task:s})=>e.jsxs("div",{className:"p-4 rounded-lg border bg-card hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsx("h4",{className:"font-medium text-foreground line-clamp-1",children:s.title}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(d,{size:"icon",variant:"ghost",className:"h-7 w-7",onClick:()=>q(s),children:e.jsx(K,{className:"w-3 h-3"})}),e.jsx(d,{size:"icon",variant:"ghost",className:"h-7 w-7 text-destructive",onClick:()=>P(s.id),children:e.jsx(A,{className:"w-3 h-3"})})]})]}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mb-2",children:s.description}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.project&&e.jsx(h,{variant:"outline",className:"text-xs",children:s.project.name}),s.due_date&&e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(Z,{className:"w-3 h-3"}),Q(new Date(s.due_date),"MMM d")]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[s.assignee?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"w-6 h-6",children:e.jsx(se,{className:"text-xs gradient-bg text-primary-foreground",children:s.assignee.full_name.split(" ").map(l=>l[0]).join("")})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.assignee.full_name})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Unassigned"}),e.jsxs(p,{value:s.status,onValueChange:l=>O(s.id,l),children:[e.jsx(g,{className:"h-7 w-28 text-xs",children:e.jsx(f,{})}),e.jsxs(v,{children:[e.jsx(n,{value:"pending",children:"Pending"}),e.jsx(n,{value:"in_progress",children:"In Progress"}),e.jsx(n,{value:"completed",children:"Completed"})]})]})]})]});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Tasks"}),e.jsxs("p",{className:"text-muted-foreground",children:[m.length," total tasks"]})]}),e.jsxs(d,{onClick:$,children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"New Task"]})]}),e.jsxs(oe,{defaultValue:"board",className:"w-full",children:[e.jsxs(me,{children:[e.jsx(B,{value:"board",children:"Board View"}),e.jsx(B,{value:"list",children:"List View"})]}),e.jsx(E,{value:"board",className:"mt-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-yellow-500"}),e.jsx("h3",{className:"font-semibold",children:"Pending"}),e.jsx(h,{variant:"secondary",children:M.length})]}),M.map(s=>e.jsx(w,{task:s},s.id))]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-500"}),e.jsx("h3",{className:"font-semibold",children:"In Progress"}),e.jsx(h,{variant:"secondary",children:F.length})]}),F.map(s=>e.jsx(w,{task:s},s.id))]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-500"}),e.jsx("h3",{className:"font-semibold",children:"Completed"}),e.jsx(h,{variant:"secondary",children:V.length})]}),V.map(s=>e.jsx(w,{task:s},s.id))]})]})}),e.jsx(E,{value:"list",className:"mt-4",children:e.jsx(ae,{children:e.jsx(te,{className:"p-0",children:e.jsx("div",{className:"divide-y",children:m.map(s=>{var l;return e.jsxs("div",{className:"flex items-center gap-4 p-4 hover:bg-muted/50",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${s.status==="completed"?"bg-green-500":s.status==="in_progress"?"bg-blue-500":"bg-yellow-500"}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:s.title}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:[((l=s.assignee)==null?void 0:l.full_name)||"Unassigned",s.project&&` â€¢ ${s.project.name}`]})]}),s.due_date&&e.jsx("span",{className:"text-sm text-muted-foreground",children:Q(new Date(s.due_date),"MMM d")}),e.jsx(h,{className:R(s.status),children:s.status.replace("_"," ")}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(d,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>q(s),children:e.jsx(K,{className:"w-4 h-4"})}),e.jsx(d,{size:"icon",variant:"ghost",className:"h-8 w-8 text-destructive",onClick:()=>P(s.id),children:e.jsx(A,{className:"w-4 h-4"})})]})]},s.id)})})})})})]}),e.jsx(ie,{open:z,onOpenChange:o,children:e.jsxs(re,{children:[e.jsx(ne,{children:e.jsx(de,{children:N?"Edit Task":"New Task"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Title *"}),e.jsx(k,{value:a.title,onChange:s=>r({...a,title:s.target.value}),placeholder:"Task title"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Description"}),e.jsx(le,{value:a.description,onChange:s=>r({...a,description:s.target.value}),placeholder:"Task description",rows:2})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Due Date"}),e.jsx(k,{type:"date",value:a.dueDate,onChange:s=>r({...a,dueDate:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Status"}),e.jsxs(p,{value:a.status,onValueChange:s=>r({...a,status:s}),children:[e.jsx(g,{children:e.jsx(f,{})}),e.jsxs(v,{children:[e.jsx(n,{value:"pending",children:"Pending"}),e.jsx(n,{value:"in_progress",children:"In Progress"}),e.jsx(n,{value:"completed",children:"Completed"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Assign To"}),e.jsxs(p,{value:a.assignedTo,onValueChange:s=>r({...a,assignedTo:s}),children:[e.jsx(g,{children:e.jsx(f,{placeholder:"Select team member"})}),e.jsx(v,{children:L.map(s=>e.jsx(n,{value:s.user_id,children:s.full_name},s.user_id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Project"}),e.jsxs(p,{value:a.projectId,onValueChange:s=>r({...a,projectId:s}),children:[e.jsx(g,{children:e.jsx(f,{placeholder:"Select project (optional)"})}),e.jsx(v,{children:U.map(s=>e.jsx(n,{value:s.id,children:s.name},s.id))})]})]})]}),e.jsxs(ce,{children:[e.jsx(d,{variant:"outline",onClick:()=>o(!1),children:"Cancel"}),e.jsx(d,{onClick:H,disabled:C,children:C?"Saving...":N?"Update":"Create"})]})]})})]})};export{Ce as default};
